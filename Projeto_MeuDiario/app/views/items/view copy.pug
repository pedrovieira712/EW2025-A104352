extends ../layout

block content
  if item
    .row
      .col-md-8
        .card
          .card-header.d-flex.justify-content-between.align-items-center
            h3.mb-0= item.title
            .btn-group
              if user && (user.id === item.submitter._id || user.isAdmin)
                a.btn.btn-outline-secondary.btn-sm(href=`/items/edit/${item._id}`) Editar
              if item.type === 'zip'
                a.btn.btn-outline-success.btn-sm(href=`/sip/export/${item._id}`) Exportar
          
          .card-body
            if item.description
              p.lead= item.description
            
            .row.mb-3
              .col-md-6
                strong Tipo: 
                span.badge(class=item.type === 'zip' ? 'bg-info' : 'bg-secondary')= item.type
              .col-md-6
                strong Categoria: 
                if item.category
                  a(href=`/categories/${item.category._id}`)= item.category.name
                else
                  span.text-muted Sem categoria
            
            .row.mb-3
              .col-md-6
                strong Produtor: 
                = item.producer
              .col-md-6
                strong Data: 
                = new Date(item.createdAt).toLocaleDateString('pt-PT')
            
            if item.tags && item.tags.length > 0
              .mb-3
                strong Tags: 
                each tag in item.tags
                  span.badge.bg-light.text-dark.me-1= tag
            
            if item.metadata && Object.keys(item.metadata).length > 0
              .mb-3
                strong Metadados:
                .mt-2
                  each value, key in item.metadata
                    .row
                      .col-md-3
                        strong= key + ':'
                      .col-md-9= value
            
            if item.files && item.files.length > 0
              h5.mt-4 Ficheiros
              .row
                each file in item.files
                  .col-md-6.mb-2
                    .card
                      .card-body.p-2
                        .d-flex.justify-content-between.align-items-center
                          div
                            strong= file.originalName
                            br
                            small.text-muted= (file.size / 1024).toFixed(1) + ' KB'
                          a.btn.btn-sm.btn-outline-primary(href=`/file/download/${file._id}`) Download
      
      .col-md-4
        .card
          .card-header
            h5.mb-0 
              i.bi.bi-chat.me-2
              | Comentários
          .card-body
            if user
              form(method='POST', action=`/comment`)
                input(type='hidden', name='itemId', value=item._id)
                .mb-3
                  textarea.form-control(name='content', rows='3', placeholder='Adicionar comentário...', required)
                .mb-3
                  select.form-select(name='type')
                    option(value='note') Nota
                    option(value='context') Contexto
                    option(value='application') Aplicação
                    option(value='correction') Correção
                button.btn.btn-primary.btn-sm(type='submit') Comentar
              hr
            
            if comments && comments.length > 0
              each comment in comments
                .mb-3.border-bottom.pb-2
                  .d-flex.justify-content-between.align-items-start
                    div
                      strong= comment.userId.name
                      small.text-muted.ms-2= new Date(comment.createdAt).toLocaleDateString('pt-PT')
                    if comment.type !== 'note'
                      span.badge.bg-secondary= comment.type
                  p.mt-1.mb-0= comment.content
            else
              p.text-muted.text-center Ainda não há comentários
  else
    .alert.alert-danger Item não encontrado