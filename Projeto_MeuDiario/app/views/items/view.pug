extends ../layout

block content
  if item
    .row
      .col-md-8
        .card
          .card-header.d-flex.justify-content-between.align-items-center
            h3.mb-0= item.title
            .btn-group
              if user && (user.id === item.submitter._id || user.isAdmin)
                a.btn.btn-outline-secondary.btn-sm(href=`/items/edit/${item._id}`) Editar
              if item.type === 'zip'
                a.btn.btn-outline-success.btn-sm(href=`/sip/export/${item._id}`) Exportar
          
          .card-body
            if item.description
              p.lead= item.description
            
            .row.mb-3
              .col-md-6
                strong Tipo: 
                span.badge(class=item.type === 'zip' ? 'bg-info' : 'bg-secondary')= item.type
              .col-md-6
                strong Categoria: 
                if item.category
                  a(href=`/categories/${item.category._id}`)= item.category.name
                else
                  span.text-muted Sem categoria
            
            .row.mb-3
              .col-md-6
                strong Produtor: 
                = item.producer
              .col-md-6
                strong Data: 
                = new Date(item.createdAt).toLocaleDateString('pt-PT')
            
            .row.mb-3
              .col-md-6
                strong Submissor: 
                = item.submitter.name
              .col-md-6
                strong Visibilidade: 
                if item.isPublic
                  span.badge.bg-success P√∫blico
                else
                  span.badge.bg-warning Privado
            
            if item.tags && item.tags.length > 0
              .mb-3
                strong Tags: 
                each tag in item.tags
                  span.badge.bg-light.text-dark.me-1= tag
            
            if item.metadata && Object.keys(item.metadata).length > 0
              .mb-3
                strong Metadados:
                .mt-2
                  each value, key in item.metadata
                    .row
                      .col-md-3
                        strong= key + ':'
                      .col-md-9= value
            
            if item.files && item.files.length > 0
              h5.mt-4 Ficheiros
              .row
                each file in item.files
                  .col-md-6.mb-2
                    .card
                      .card-body.p-2
                        .d-flex.justify-content-between.align-items-center
                          div
                            strong= file.originalName
                            br
                            small.text-muted= (file.size / 1024).toFixed(1) + ' KB'
                            br
                            small.text-muted= file.fileType
                          // Download direto da API
                          a.btn.btn-primary.btn-sm(href=`http://localhost:25000/file/download/${file._id}`, download, target='_blank') 
                            i.bi.bi-download.me-1
                            | Download
      
      .col-md-4
        .card
          .card-header
            h5.mb-0 
              i.bi.bi-chat.me-2
              | Coment√°rios
              if comments
                span.badge.bg-primary.ms-2= comments.length
          .card-body
            // Verificar se pode comentar
            - var canComment = user && (item.isPublic || user.id === item.submitter._id || user.isAdmin)
            
            if canComment
              .alert.alert-info.small
                i.bi.bi-info-circle.me-2
                | Os coment√°rios ajudam a qualificar e contextualizar este item.
              
              form(method='POST', action='/comment')
                input(type='hidden', name='itemId', value=item._id)
                .mb-3
                  label.form-label Coment√°rio
                  textarea.form-control(name='content', rows='3', placeholder='Adicionar coment√°rio...', required)
                .mb-3
                  label.form-label Tipo de Coment√°rio
                  select.form-select(name='type')
                    option(value='note') üìù Nota Geral
                    option(value='context') üåç Contexto Hist√≥rico
                    option(value='application') üéØ Aplica√ß√£o/Uso
                    option(value='correction') ‚úèÔ∏è Corre√ß√£o
                    option(value='enhancement') ‚≠ê Melhoria
                  .form-text Escolha o tipo que melhor descreve seu coment√°rio
                button.btn.btn-primary.btn-sm(type='submit') 
                  i.bi.bi-plus.me-1
                  | Adicionar Coment√°rio
              hr
            else if !user
              .alert.alert-warning.text-center
                i.bi.bi-lock.me-2
                | Fa√ßa login para comentar
                br
                a.btn.btn-primary.btn-sm.mt-2(href='/auth/login') Login
            else if !item.isPublic
              .alert.alert-info.text-center
                i.bi.bi-eye-slash.me-2
                | Item privado - apenas o autor pode comentar
            
            // Mostrar coment√°rios
            if comments && comments.length > 0
              .comments-container
                each comment in comments
                  .comment-item.mb-3.border-bottom.pb-3
                    .d-flex.justify-content-between.align-items-start.mb-2
                      .comment-header
                        .d-flex.align-items-center
                          strong= comment.userId.name
                          if comment.type !== 'note'
                            span.badge.bg-secondary.ms-2= getCommentTypeLabel(comment.type)
                        small.text-muted= new Date(comment.createdAt).toLocaleDateString('pt-PT') + ' √†s ' + new Date(comment.createdAt).toLocaleTimeString('pt-PT')
                      
                      // A√ß√µes do coment√°rio - APENAS ELIMINAR
                      if user && (user.id === comment.userId._id || user.isAdmin)
                        button.btn.btn-sm.btn-outline-danger(onclick=`deleteComment('${comment._id}', '${item._id}')`) 
                          i.bi.bi-trash.me-1
                          | Eliminar
                    
                    .comment-content
                      p.mb-0= comment.content
            else
              .text-center.text-muted.py-4
                i.bi.bi-chat-square.fs-1.d-block.mb-2.opacity-50
                p Ainda n√£o h√° coment√°rios
                if canComment
                  p.small Seja o primeiro a comentar!

  script.
    // Fun√ß√£o para obter label do tipo de coment√°rio
    function getCommentTypeLabel(type) {
      switch(type) {
        case 'context': return 'üåç Contexto';
        case 'application': return 'üéØ Aplica√ß√£o';
        case 'correction': return '‚úèÔ∏è Corre√ß√£o';
        case 'enhancement': return '‚≠ê Melhoria';
        default: return 'üìù Nota';
      }
    }
    
    // Fun√ß√£o para eliminar coment√°rio
    function deleteComment(commentId, itemId) {
      if (confirm('Tem certeza que deseja eliminar este coment√°rio?')) {
        // Criar form tempor√°rio para DELETE
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/comment/${commentId}/delete`;
        
        const itemInput = document.createElement('input');
        itemInput.type = 'hidden';
        itemInput.name = 'itemId';
        itemInput.value = itemId;
        form.appendChild(itemInput);
        
        document.body.appendChild(form);
        form.submit();
      }
    }
